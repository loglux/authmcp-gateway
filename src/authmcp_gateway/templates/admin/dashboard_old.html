{% extends "admin/base.html" %}

{% block title %}Dashboard - Auth MCP Admin{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
            <i data-lucide="gauge" class="w-8 h-8 text-blue-600"></i>
            Dashboard
        </h1>
        <p class="text-gray-600 mt-1">Overview of your Auth MCP Gateway</p>
    </div>
    <button 
        onclick="loadStats()"
        class="px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg shadow-sm transition-colors flex items-center gap-2"
    >
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        Refresh
    </button>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Users -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Total Users</p>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="totalUsers">-</p>
            </div>
            <div class="p-3 bg-blue-100 rounded-lg">
                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
            </div>
        </div>
    </div>

    <!-- Active Users -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-cyan-500 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Active Users</p>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="activeUsers">-</p>
            </div>
            <div class="p-3 bg-cyan-100 rounded-lg">
                <i data-lucide="user-check" class="w-6 h-6 text-cyan-600"></i>
            </div>
        </div>
    </div>

    <!-- Superusers -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-emerald-500 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Superusers</p>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="superUsers">-</p>
            </div>
            <div class="p-3 bg-emerald-100 rounded-lg">
                <i data-lucide="shield-check" class="w-6 h-6 text-emerald-600"></i>
            </div>
        </div>
    </div>

    <!-- Recent Logins -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Recent Logins (24h)</p>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="recentLogins">-</p>
            </div>
            <div class="p-3 bg-orange-100 rounded-lg">
                <i data-lucide="activity" class="w-6 h-6 text-orange-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Token Expiration Warnings -->
<div id="tokenWarnings" class="mb-6" style="display: none;">
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-400 rounded-lg shadow-sm p-5">
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0 mt-0.5">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-bold text-yellow-900 mb-2">Token Expiration Warnings</h3>
                <div id="warningsList" class="space-y-2">
                    <!-- Warnings will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info Panels -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- System Info -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4 flex items-center gap-2 text-white">
            <i data-lucide="info" class="w-5 h-5"></i>
            <h2 class="text-lg font-semibold">System Info</h2>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div class="flex justify-between py-3 border-b border-gray-100">
                    <span class="font-medium text-gray-700">JWT Algorithm:</span>
                    <span class="text-gray-900 font-mono text-sm" id="jwtAlgorithm">-</span>
                </div>
                <div class="flex justify-between py-3 border-b border-gray-100">
                    <span class="font-medium text-gray-700">Access Token TTL:</span>
                    <span class="text-gray-900 font-mono text-sm" id="accessTokenTtl">-</span>
                </div>
                <div class="flex justify-between py-3 border-b border-gray-100">
                    <span class="font-medium text-gray-700">Refresh Token TTL:</span>
                    <span class="text-gray-900 font-mono text-sm" id="refreshTokenTtl">-</span>
                </div>
                <div class="flex justify-between py-3">
                    <span class="font-medium text-gray-700">Public URL:</span>
                    <span class="text-gray-900 font-mono text-sm truncate max-w-xs" id="publicUrl">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- API Endpoints -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-cyan-600 to-blue-600 px-6 py-4 flex items-center gap-2 text-white">
            <i data-lucide="link" class="w-5 h-5"></i>
            <h2 class="text-lg font-semibold">API Endpoints</h2>
        </div>
        <div class="p-6">
            <div class="space-y-3">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                    <code class="text-sm font-mono text-blue-600">POST /auth/register</code>
                    <p class="text-xs text-gray-600 mt-1">User registration</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                    <code class="text-sm font-mono text-blue-600">POST /auth/login</code>
                    <p class="text-xs text-gray-600 mt-1">User login (JWT tokens)</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                    <code class="text-sm font-mono text-blue-600">GET /auth/me</code>
                    <p class="text-xs text-gray-600 mt-1">Current user profile</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                    <code class="text-sm font-mono text-blue-600">POST /mcp</code>
                    <p class="text-xs text-gray-600 mt-1">MCP protocol endpoint</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function loadStats() {
        try {
            const response = await fetch('/admin/api/stats');
            const data = await response.json();

            // Update stats
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('activeUsers').textContent = data.active_users;
            document.getElementById('superUsers').textContent = data.superusers;
            document.getElementById('recentLogins').textContent = data.recent_logins;

            // Update system info
            if (data.system) {
                document.getElementById('jwtAlgorithm').textContent = data.system.jwt_algorithm;
                document.getElementById('accessTokenTtl').textContent = data.system.access_token_ttl;
                document.getElementById('refreshTokenTtl').textContent = data.system.refresh_token_ttl;
                document.getElementById('publicUrl').textContent = data.system.public_url;
            }
            
            // Re-initialize icons after DOM update
            lucide.createIcons();
        } catch (error) {
            console.error('Failed to load stats:', error);
            document.getElementById('totalUsers').textContent = 'Error';
            document.getElementById('activeUsers').textContent = 'Error';
            document.getElementById('superUsers').textContent = 'Error';
            document.getElementById('recentLogins').textContent = 'Error';
        }
    }

    async function loadTokenWarnings() {
        try {
            const response = await fetch('/admin/api/mcp-servers/token-status');
            const data = await response.json();
            
            // Filter servers with warnings or expired tokens
            const warnings = data.servers.filter(s => 
                s.token_status.status === 'warning' || s.token_status.status === 'expired'
            );
            
            const warningsContainer = document.getElementById('tokenWarnings');
            const warningsList = document.getElementById('warningsList');
            
            if (warnings.length > 0) {
                // Sort: expired first, then by days_left
                warnings.sort((a, b) => {
                    if (a.token_status.status === 'expired' && b.token_status.status !== 'expired') return -1;
                    if (a.token_status.status !== 'expired' && b.token_status.status === 'expired') return 1;
                    return (a.token_status.days_left || 0) - (b.token_status.days_left || 0);
                });
                
                warningsList.innerHTML = warnings.map(server => {
                    const isExpired = server.token_status.status === 'expired';
                    const daysLeft = server.token_status.days_left;
                    const expiresAt = server.token_status.expires_at_formatted;
                    const icon = isExpired ? 'ðŸ”´' : 'ðŸŸ¡';
                    const text = isExpired 
                        ? `<strong>${server.name}</strong> - Token expired ${Math.abs(daysLeft)} day(s) ago (${expiresAt})`
                        : `<strong>${server.name}</strong> - Token expires in ${daysLeft} day(s) (${expiresAt})`;
                    
                    return `
                        <div class="flex items-center gap-2 text-sm ${isExpired ? 'text-red-700' : 'text-yellow-700'}">
                            <span>${icon}</span>
                            <span>${text}</span>
                            <a href="/admin/mcp-servers" class="ml-auto text-blue-600 hover:text-blue-800 underline">Update</a>
                        </div>
                    `;
                }).join('');
                
                warningsContainer.style.display = 'block';
            } else {
                warningsContainer.style.display = 'none';
            }
            
            lucide.createIcons();
        } catch (error) {
            console.error('Failed to load token warnings:', error);
        }
    }

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadTokenWarnings();
        // Refresh every 30 seconds
        setInterval(loadStats, 30000);
        setInterval(loadTokenWarnings, 60000); // Check tokens every minute
    });
</script>
{% endblock %}
