# Deployment Guide

This guide covers deploying AuthMCP Gateway in production environments with HTTPS, reverse proxies, and cloud platforms.

## Table of Contents

- [Installation Methods](#installation-methods)
- [Docker Deployment](#docker-deployment)
- [HTTPS Setup](#https-setup)
- [Reverse Proxy Configuration](#reverse-proxy-configuration)
- [Cloud Deployments](#cloud-deployments)
- [Environment Configuration](#environment-configuration)
- [Security Hardening](#security-hardening)

---

## Installation Methods

### Option 1: PyPI Package (Recommended for Quick Start)

Install directly from PyPI:

```bash
# Install package
pip install authmcp-gateway

# Run with default settings
authmcp-gateway

# Or with custom port
GATEWAY_PORT=9105 authmcp-gateway

# Or create systemd service (see Production Setup below)
```

**Pros:**
- Fastest installation
- Automatic dependency management
- Easy updates with `pip install --upgrade authmcp-gateway`

**Cons:**
- Requires Python 3.11+ on host
- Manual process management

### Production Setup with PyPI Package

**Create systemd service (`/etc/systemd/system/authmcp-gateway.service`):**

```ini
[Unit]
Description=AuthMCP Gateway
After=network.target

[Service]
Type=simple
User=authmcp
Group=authmcp
WorkingDirectory=/opt/authmcp-gateway
Environment="PATH=/opt/authmcp-gateway/venv/bin"
Environment="GATEWAY_PORT=9105"
Environment="JWT_SECRET_KEY=your-secret-key"
ExecStart=/opt/authmcp-gateway/venv/bin/authmcp-gateway
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**Setup:**
```bash
# Create user
sudo useradd -r -s /bin/false authmcp

# Create directory
sudo mkdir -p /opt/authmcp-gateway
sudo chown authmcp:authmcp /opt/authmcp-gateway

# Install in venv
sudo -u authmcp python3 -m venv /opt/authmcp-gateway/venv
sudo -u authmcp /opt/authmcp-gateway/venv/bin/pip install authmcp-gateway

# Start service
sudo systemctl daemon-reload
sudo systemctl enable authmcp-gateway
sudo systemctl start authmcp-gateway

# Check status
sudo systemctl status authmcp-gateway
```

### Option 2: Docker (Recommended for Production)

See [Docker Deployment](#docker-deployment) section below.

**Pros:**
- Isolated environment
- Easy orchestration
- Production-ready with Docker Compose

---

## Docker Deployment

### Quick Start

```bash
# Clone repository
git clone https://github.com/loglux/authmcp-gateway.git
cd authmcp-gateway

# Configure environment
cp .env.example .env
nano .env  # Edit settings

# Start services
docker-compose up -d

# Check logs
docker-compose logs -f
```

### Production Docker Compose

```yaml
version: '3.8'

services:
  authmcp-gateway:
    build: .
    container_name: authmcp-gateway
    restart: unless-stopped
    ports:
      - "127.0.0.1:9105:8000"  # Only localhost access
    volumes:
      - ./data:/app/data
      - ./logs:/app/data/logs
    environment:
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=10080
      - ADMIN_TOKEN_EXPIRE_MINUTES=480
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - authmcp

networks:
  authmcp:
    driver: bridge
```

### Changing Port

**In `.env`:**
```bash
GATEWAY_PORT=8080  # Change port mapping
```

**In `docker-compose.yml`:**
```yaml
ports:
  - "127.0.0.1:8080:8000"  # Map to different host port
```

**Restart:**
```bash
docker-compose down && docker-compose up -d
```

---

## HTTPS Setup

**⚠️ IMPORTANT:** Claude.ai and most MCP clients **require HTTPS**. You cannot use `http://` URLs.

### Option 1: Nginx with Let's Encrypt (Recommended)

**Install Nginx + Certbot:**
```bash
sudo apt update
sudo apt install nginx certbot python3-certbot-nginx
```

**Nginx Configuration (`/etc/nginx/sites-available/authmcp`):**
```nginx
server {
    listen 80;
    server_name mcp.yourdomain.com;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name mcp.yourdomain.com;

    # SSL certificates (auto-generated by certbot)
    ssl_certificate /etc/letsencrypt/live/mcp.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mcp.yourdomain.com/privkey.pem;

    # SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Proxy to AuthMCP Gateway
    location / {
        proxy_pass http://127.0.0.1:9105;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support (for future streaming)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
}
```

**Enable site:**
```bash
sudo ln -s /etc/nginx/sites-available/authmcp /etc/nginx/sites-enabled/
sudo nginx -t  # Test configuration
sudo systemctl reload nginx
```

**Get SSL certificate:**
```bash
sudo certbot --nginx -d mcp.yourdomain.com
```

**Auto-renewal (cron):**
```bash
# Add to crontab
0 3 * * * certbot renew --quiet --post-hook "systemctl reload nginx"
```

**Update `.env`:**
```bash
MCP_PUBLIC_URL=https://mcp.yourdomain.com
```

---

### Option 2: Cloudflare Tunnel

Cloudflare Tunnel provides HTTPS without managing SSL certificates or exposing ports.

**Install cloudflared:**
```bash
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared-linux-amd64.deb
```

**Authenticate:**
```bash
cloudflared tunnel login
```

**Create tunnel:**
```bash
cloudflared tunnel create authmcp-gateway
```

**Configure tunnel (`~/.cloudflared/config.yml`):**
```yaml
tunnel: <YOUR_TUNNEL_ID>
credentials-file: /home/user/.cloudflared/<YOUR_TUNNEL_ID>.json

ingress:
  - hostname: mcp.yourdomain.com
    service: http://localhost:9105
  - service: http_status:404
```

**Route DNS:**
```bash
cloudflared tunnel route dns authmcp-gateway mcp.yourdomain.com
```

**Run tunnel:**
```bash
cloudflared tunnel run authmcp-gateway
```

**Run as service:**
```bash
sudo cloudflared service install
sudo systemctl start cloudflared
sudo systemctl enable cloudflared
```

**Update `.env`:**
```bash
MCP_PUBLIC_URL=https://mcp.yourdomain.com
```

---

### Option 3: Traefik (Docker)

```yaml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@yourdomain.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"

  authmcp-gateway:
    build: .
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authmcp.rule=Host(`mcp.yourdomain.com`)"
      - "traefik.http.routers.authmcp.entrypoints=websecure"
      - "traefik.http.routers.authmcp.tls.certresolver=letsencrypt"
```

---

## Reverse Proxy Configuration

### Apache

```apache
<VirtualHost *:443>
    ServerName mcp.yourdomain.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/mcp.yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/mcp.yourdomain.com/privkey.pem

    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:9105/
    ProxyPassReverse / http://127.0.0.1:9105/

    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options "nosniff"
</VirtualHost>
```

### Caddy

```caddy
mcp.yourdomain.com {
    reverse_proxy localhost:9105
    
    # Auto HTTPS with Let's Encrypt
    tls admin@yourdomain.com
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
    }
}
```

---

## Cloud Deployments

### Railway.app

1. Create new project
2. Add GitHub repository
3. Set environment variables in Railway dashboard
4. Deploy automatically on push

**Environment Variables:**
```bash
JWT_SECRET_KEY=your-secret-key
GATEWAY_PORT=8000
MCP_PUBLIC_URL=https://your-app.railway.app
```

### Render.com

**`render.yaml`:**
```yaml
services:
  - type: web
    name: authmcp-gateway
    env: docker
    dockerfilePath: ./Dockerfile
    envVars:
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: GATEWAY_PORT
        value: 8000
    healthCheckPath: /health
```

### DigitalOcean App Platform

1. Create App from GitHub
2. Select Dockerfile
3. Set environment variables
4. Enable HTTPS (automatic)

### AWS ECS (Fargate)

**Task Definition:**
```json
{
  "family": "authmcp-gateway",
  "containerDefinitions": [
    {
      "name": "gateway",
      "image": "authmcp-gateway:latest",
      "portMappings": [
        {
          "containerPort": 8000,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "JWT_SECRET_KEY",
          "value": "your-secret-key"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/authmcp-gateway",
          "awslogs-region": "us-east-1",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ],
  "requiresCompatibilities": ["FARGATE"],
  "networkMode": "awsvpc",
  "cpu": "256",
  "memory": "512"
}
```

---

## Environment Configuration

### Production `.env`

```bash
# JWT Configuration
JWT_SECRET_KEY=<GENERATE_STRONG_KEY>
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=10080   # 7 days
JWT_REFRESH_TOKEN_EXPIRE_DAYS=30
ADMIN_TOKEN_EXPIRE_MINUTES=480          # 8 hours

# Server Configuration
GATEWAY_HOST=0.0.0.0
GATEWAY_PORT=8000
MCP_PUBLIC_URL=https://mcp.yourdomain.com

# Database
SQLITE_PATH=data/auth.db

# Security
PASSWORD_MIN_LENGTH=12
PASSWORD_REQUIRE_UPPERCASE=true
PASSWORD_REQUIRE_LOWERCASE=true
PASSWORD_REQUIRE_DIGIT=true
PASSWORD_REQUIRE_SPECIAL=true

# Rate Limiting
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS_PER_MINUTE=60

# Logging
LOG_LEVEL=INFO
```

### Generate Strong Secret Key

```bash
# Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# OpenSSL
openssl rand -base64 32
```

---

## Security Hardening

### 1. Network Security

**Bind to localhost only:**
```yaml
ports:
  - "127.0.0.1:9105:8000"  # Not accessible from external network
```

**Use private network:**
```yaml
networks:
  authmcp:
    internal: true  # No external access
```

### 2. Container Security

**Run as non-root:**
```dockerfile
RUN useradd -m -u 1000 authmcp
USER authmcp
```

**Read-only filesystem:**
```yaml
services:
  authmcp-gateway:
    read_only: true
    tmpfs:
      - /tmp
```

### 3. Database Security

**Encrypt database:**
```bash
# Use SQLCipher for encrypted SQLite
pip install sqlcipher3
```

**Backup encryption:**
```bash
# Encrypt backups with GPG
gpg --encrypt --recipient admin@yourdomain.com data/auth.db
```

### 4. Secrets Management

**Use Docker Secrets:**
```yaml
services:
  authmcp-gateway:
    secrets:
      - jwt_secret

secrets:
  jwt_secret:
    file: ./secrets/jwt_secret.txt
```

**Use environment file:**
```bash
# Don't commit .env to git
echo ".env" >> .gitignore
```

---

## Monitoring

### Health Checks

```bash
# HTTP health check
curl http://localhost:9105/health

# Docker healthcheck
docker inspect authmcp-gateway | jq '.[0].State.Health'
```

### Prometheus Metrics (Future)

```yaml
# Add metrics endpoint
- path: /metrics
  service: prometheus
```

---

## Troubleshooting

### Container won't start

```bash
# Check logs
docker-compose logs

# Check environment
docker-compose config

# Restart fresh
docker-compose down -v && docker-compose up -d
```

### HTTPS not working

```bash
# Test SSL certificate
openssl s_client -connect mcp.yourdomain.com:443

# Check Nginx logs
sudo tail -f /var/log/nginx/error.log
```

### Performance issues

```bash
# Check resource usage
docker stats authmcp-gateway

# Increase resources
docker-compose up -d --scale authmcp-gateway=2
```

---

## Related Documentation

- [Security Testing Guide](SECURITY_TESTING.md)
- [Logging Architecture](LOGGING.md)
- [API Reference](API.md)
